name: Build GSocket for Windows (Final Fix)

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: ubuntu-latest

    env:
      OPENSSL_VER: "3.1.4"
  
    steps:
      - name: Checkout GSocket Source
        uses: actions/checkout@v4
        with:
          repository: hackerschoice/gsocket
          path: gsocket-src

      - name: Install MinGW and Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 autoconf automake libtool make pkg-config wget tar

      - name: Download and Compile Static OpenSSL (for Windows)
        run: |
          echo "Downloading OpenSSL..."
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VER }}.tar.gz
          tar -xzf openssl-${{ env.OPENSSL_VER }}.tar.gz
          mv openssl-${{ env.OPENSSL_VER }} openssl-build
      
          cd openssl-build
      
          ./Configure mingw64 no-shared no-dso \
            --cross-compile-prefix=x86_64-w64-mingw32- \
            --prefix=$GITHUB_WORKSPACE/openssl-dist \
            --libdir=lib
      
          echo "Compiling OpenSSL..."
          make -j$(nproc)
          make install_sw
      
          echo "OpenSSL installed. Verifying:"
          ls -la $GITHUB_WORKSPACE/openssl-dist/lib/*.a

      - name: Compile GSocket (Windows Static Exe)
        run: |
          cd gsocket-src
          ./bootstrap
      
          SSL_ROOT="$GITHUB_WORKSPACE/openssl-dist"
      
          # ===== 核心修复 =====
          # configure 时必须提供完整的链接标志，否则 libcrypto 检测会失败
          # 静态 OpenSSL 依赖 Windows 系统库：ws2_32, gdi32, crypt32
          
          echo "Configuring GSocket with full linking flags..."
          ./configure \
            --host=x86_64-w64-mingw32 \
            CPPFLAGS="-I$SSL_ROOT/include" \
            CFLAGS="-O2" \
            LDFLAGS="-L$SSL_ROOT/lib -static" \
            LIBS="-lssl -lcrypto -lws2_32 -lgdi32 -lcrypt32"
      
          echo "Building..."
          make -j$(nproc)
      
          echo "Build complete. Checking output:"
          ls -lh tools/*.exe
          file tools/gs-netcat.exe
          x86_64-w64-mingw32-objdump -p tools/gs-netcat.exe | grep "DLL Name" || echo "Fully static - no DLL dependencies"

      - name: Prepare Artifact
        run: |
          mkdir build-output
          find gsocket-src -name "*.exe" -exec cp {} build-output/ \;
          ls -la build-output/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gsocket-windows-exe
          path: build-output/
          retention-days: 5
