name: Build GSocket with Cygwin

on:
  workflow_dispatch:

jobs:
  build-cygwin:
    runs-on: windows-latest

    steps:
      - name: Install Cygwin
        uses: cygwin/cygwin-install-action@v4
        with:
          packages: >-
            gcc-core
            make
            automake
            autoconf
            libtool
            libssl-devel
            libssl3
            git
            curl
            wget

      - name: Clone and Build GSocket
        shell: C:\cygwin\bin\bash.exe --login -eo pipefail '{0}'
        run: |
          cd /cygdrive/d/a
          
          # Clone source
          git clone https://github.com/hackerschoice/gsocket.git
          cd gsocket
          
          # Build
          ./bootstrap
          ./configure
          make -j$(nproc)
          
          # Check result
          ls -lh tools/gs-netcat.exe
          file tools/gs-netcat.exe

      - name: Copy Cygwin DLLs (Required for running)
        shell: C:\cygwin\bin\bash.exe --login -eo pipefail '{0}'
        run: |
          cd /cygdrive/d/a/gsocket
          mkdir -p dist
          
          # Copy executable
          cp tools/gs-netcat.exe dist/
          
          # Copy required Cygwin DLLs
          cp /usr/bin/cygwin1.dll dist/
          cp /usr/bin/cygssl-3.dll dist/ || cp /usr/bin/cygssl-*.dll dist/
          cp /usr/bin/cygcrypto-3.dll dist/ || cp /usr/bin/cygcrypto-*.dll dist/
          cp /usr/bin/cygz.dll dist/ || true
          
          ls -la dist/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gs-netcat-cygwin
          path: D:\a\gsocket\dist\*
