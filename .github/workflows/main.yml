name: Build GSocket with Cygwin

on:
  workflow_dispatch:

jobs:
  build-cygwin:
    runs-on: windows-latest

    steps:
      - name: Install Cygwin
        uses: cygwin/cygwin-install-action@v4
        with:
          packages: >-
            gcc-core
            make
            automake
            autoconf
            libtool
            libssl-devel
            git
            wget

      - name: Build and Collect Artifacts
        working-directory: D:\a
        shell: C:\cygwin\bin\bash.exe --login --norc -eo pipefail -o igncr {0}
        run: |
          cd /cygdrive/d/a
          rm -rf gsocket-build
          git clone https://github.com/hackerschoice/gsocket.git gsocket-build
          cd gsocket-build
          ./bootstrap
          ./configure LDFLAGS="-mwindows"
          make -j$(nproc)
          ls -lh tools/gs-netcat.exe
          
          # Collect artifacts
          mkdir -p dist
          cp tools/gs-netcat.exe dist/
          cp tools/gs-mount.exe dist/ || true
          cp tools/gs-sftp.exe dist/ || true
          cp tools/blitz.exe dist/ || true
          cp /usr/bin/cygwin1.dll dist/
          cp /usr/bin/cygssl-*.dll dist/
          cp /usr/bin/cygcrypto-*.dll dist/
          cp /usr/bin/cygz.dll dist/ || true
          ls -la dist/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gs-netcat-cygwin
          path: D:\a\gsocket-build\dist\*
